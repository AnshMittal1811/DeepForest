---
title: "Lidar"
author: "Ben Weinstein"
date: "4/3/2018"
output: html_document
---

LidR raster example

```{r}
library(lidR)

LASfile <- system.file("extdata", "Topography.laz", package="lidR")
las = readLAS(LASfile, select = "xyz")

ws = seq(3,21, 3)
th = seq(0.1, 2, length.out = length(ws))

lasground(las, "pmf", ws, th)

# normalization
lasnormalize(las, method = "knnidw", k = 10L)

# compute a canopy image
chm= grid_canopy (las, 1, subcircle = 0.1, na.fill = "knnidw", k = 3, p = 2)
chm = as.raster(chm)
kernel = matrix(1,3,3)
chm = raster::focal(chm, w = kernel, fun = mean)
chm = raster::focal(chm, w = kernel, fun = mean)

# tree segmentation
crowns = lastrees(las, "watershed", chm, th = 4, extra = TRUE)

# display
tree = lasfilter(las, !is.na(treeID))
plot(tree, color = "treeID", colorPalette = pastel.colors(100), size = 1)

# More stuff
library(raster)
contour = rasterToPolygons(crowns, dissolve = TRUE)

plot(chm, col = height.colors(50))
plot(contour, add = T)
```

```{r setup, include=FALSE}
library(lidR)
library(ggplot2)
library(raster)
tile=readLAS("../tests/data/NEON_D03_OSBS_DP1_405000_3276000_classified_point_cloud.laz")

tile<-tile %>% lasfilter(Z < 100)
tile<-tile %>% lasfilter(Z > 0)

#plot(tile, color="Z", colorPalette = heat.colors(50), trim=0.99)

#remove 
summary(tile)
#table(tile@data$Classification)
#ggplot(tile@data,aes(x=as.factor(Classification),y=Z)) + geom_boxplot()
```

```{r}
tree_example<-function(las){

ws = seq(3,21, 3)
th = seq(0.1, 2, length.out = length(ws))

lasground(las, "pmf", ws, th)

# normalization
lasnormalize(las, method = "knnidw", k = 10L)

# compute a canopy image
chm= grid_canopy (las, 1, subcircle = 0.1, na.fill = "knnidw", k = 3, p = 2)
chm = as.raster(chm)
kernel = matrix(1,3,3)
chm = raster::focal(chm, w = kernel, fun = mean)
chm = raster::focal(chm, w = kernel, fun = mean)

# tree segmentation
crowns = lastrees(las, algorithm ="watershed", chm, th = 4, extra = TRUE)

# display
tree = lasfilter(las, !is.na(treeID))
plot(tree, color = "treeID", colorPalette = pastel.colors(100), size = 1)

# More stuff
contour = rasterToPolygons(crowns, dissolve = TRUE)

plot(chm, col = height.colors(50))
plot(contour, add = T)
return(contour)
}
```

```{r}
system.time(contours<-tree_example(tile))

```
